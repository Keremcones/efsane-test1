<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-title" content="Rolin Signal">
    <title>Rolin Signal • Binance Bağlantısı</title>
    <meta name="description" content="Binance API bağlantınızı yönetin, otomatik trade ayarlarını yapın ve bakiyenizi doğrulayın." />
    <link rel="canonical" href="https://www.rolinsignal.com/binance.html" />
    <script>
        if (localStorage.getItem('DEBUG_CONSOLE') !== 'true') {
            console.log = () => {};
            console.info = () => {};
            console.warn = () => {};
            console.debug = () => {};
        }
    </script>
    <link rel="icon" type="image/svg+xml" href="/logo.svg">
    <link rel="icon" href="/favicon.ico" sizes="any">
    <link rel="icon" type="image/png" sizes="48x48" href="/favicon-48x48.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="167x167" href="/apple-touch-icon-167.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120.png">
    <link rel="apple-touch-icon-precomposed" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png">
    <link rel="manifest" href="/site.webmanifest">
    <meta name="theme-color" content="#0b0f14">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="/api/env.js"></script>
    <script src="config.js"></script>
    <script>
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.dataset.theme = savedTheme;
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #3a7bd5;
            --secondary: #4f46e5;
            --surface-dark: #f8fafc;
            --bg-surface: #eef2f6;
            --border-color: rgba(79, 70, 229, 0.22);
            --text-primary: #1f2a44;
            --text-secondary: #5c6b87;
            --success: #2f8f7a;
            --error: #e15b64;
            --warning: #c9a227;
        }
        html[data-theme="dark"] {
            --primary: #38e8ff;
            --secondary: #8b5cf6;
            --surface-dark: #141c2a;
            --bg-surface: #0b0f14;
            --border-color: rgba(56, 232, 255, 0.28);
            --text-primary: #ffffff;
            --text-secondary: #9aa4b2;
            --success: #35d28c;
            --error: #ff4d6d;
            --warning: #f5b75b;
        }
        html[data-theme="purple"] {
            --primary: #b86cff;
            --secondary: #7c5cff;
            --surface-dark: #191026;
            --bg-surface: #0b0714;
            --border-color: rgba(184, 108, 255, 0.32);
            --text-primary: #f6efff;
            --text-secondary: #c2b4d6;
            --success: #35d28c;
            --error: #ff5c7a;
            --warning: #f5b75b;
        }
        html[data-theme="gold"] {
            --primary: #f5d06f;
            --secondary: #ffd86b;
            --surface-dark: #1b181a;
            --bg-surface: #0b0b0b;
            --border-color: rgba(245, 208, 111, 0.3);
            --text-primary: #f6f1e7;
            --text-secondary: #c9bba0;
            --success: #35d28c;
            --error: #ff6b7a;
            --warning: #f5d06f;
        }
        body {
            background: radial-gradient(circle at 12% 15%, rgba(58, 123, 213, 0.16), transparent 46%),
                        radial-gradient(circle at 88% 10%, rgba(79, 70, 229, 0.14), transparent 42%),
                        linear-gradient(150deg, var(--bg-surface) 0%, var(--surface-dark) 100%);
            color: var(--text-primary);
            font-family: 'Sora', sans-serif;
            min-height: 100vh;
            padding: 0;
        }
        .navbar {
            background: rgba(240, 246, 255, 0.82);
            border-bottom: 1px solid rgba(124, 92, 255, 0.24);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(14px);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 12px 30px rgba(86, 110, 170, 0.22);
            min-height: 72px;
        }
        html[data-theme="dark"] .navbar {
            background: rgba(11, 15, 20, 0.78);
            border-bottom: 1px solid rgba(56, 232, 255, 0.16);
            box-shadow: 0 10px 24px rgba(5, 12, 24, 0.5);
        }
        html[data-theme="purple"] .navbar {
            background: rgba(11, 7, 20, 0.82);
            border-bottom: 1px solid rgba(184, 108, 255, 0.22);
            box-shadow: 0 10px 24px rgba(10, 6, 18, 0.6);
        }
        html[data-theme="gold"] .navbar {
            background: rgba(11, 11, 11, 0.86);
            border-bottom: 1px solid rgba(245, 208, 111, 0.3);
            box-shadow: 0 10px 24px rgba(5, 4, 3, 0.7);
        }
        .navbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            background: rgba(56, 232, 255, 0.08);
            border: 1px solid rgba(56, 232, 255, 0.2);
            color: var(--primary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            padding: 8px 10px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .back-btn:hover {
            transform: translateX(-4px);
            color: var(--secondary);
        }

        .logo {
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo-img {
            width: 28px;
            height: 28px;
            flex: 0 0 28px;
            filter: drop-shadow(0 0 10px rgba(56, 232, 255, 0.35));
        }

        .logo-text {
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 0.4px;
            color: transparent;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
        }

        .user-email-header {
            color: var(--text-secondary);
            font-size: 14px;
        }
        .user-role-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            letter-spacing: 0.4px;
        }
        .user-role-badge.standard { background: linear-gradient(135deg, #c07a2b, #8b4f1f); color: #ffffff; }
        .user-role-badge.premium { background: linear-gradient(135deg, #FFD700, #FFA500); box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); color: #111111; }
        .user-role-badge.admin { background: linear-gradient(135deg, #f5d06f, #ffd86b); box-shadow: 0 0 18px rgba(245, 208, 111, 0.45); color: #0a0a0a; }
        .hamburger-menu {
            display: flex;
            flex-direction: column;
            background: rgba(13, 168, 232, 0.1);
            border: 1px solid rgba(13, 168, 232, 0.3);
            cursor: pointer;
            padding: 8px;
            gap: 5px;
            width: 44px;
            height: 44px;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .hamburger-menu:hover {
            background: rgba(13, 168, 232, 0.2);
            border-color: #0da8e8;
        }

        .hamburger-menu span {
            width: 26px;
            height: 3px;
            background: #0da8e8;
            border-radius: 2px;
            transition: all 0.3s ease;
            display: block;
        }

        .hamburger-menu.active span:nth-child(1) {
            transform: rotate(45deg) translate(8px, 8px);
        }

        .hamburger-menu.active span:nth-child(2) {
            opacity: 0;
        }

        .hamburger-menu.active span:nth-child(3) {
            transform: rotate(-45deg) translate(7px, -7px);
        }

        .menu-panel {
            position: fixed;
            right: -350px;
            top: 0;
            width: 350px;
            height: 100vh;
            background: rgba(15, 18, 28, 0.96);
            border-left: 1px solid rgba(56, 232, 255, 0.18);
            z-index: 998;
            transition: right 0.3s ease;
            overflow-y: auto;
            backdrop-filter: blur(8px);
        }

        .menu-panel.active {
            right: 0;
        }

        html[data-theme="light"] .menu-panel {
            background: rgba(233, 238, 248, 0.96);
            border-left: 1px solid rgba(79, 70, 229, 0.18);
        }

        html[data-theme="purple"] .menu-panel {
            background: rgba(12, 8, 22, 0.96);
            border-left: 1px solid rgba(184, 108, 255, 0.25);
        }

        html[data-theme="gold"] .menu-panel {
            background: rgba(12, 11, 12, 0.96);
            border-left: 1px solid rgba(245, 208, 111, 0.28);
        }

        .menu-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--primary);
            font-size: 32px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .menu-close:hover {
            color: var(--secondary);
            transform: rotate(90deg);
        }

        .menu-content {
            padding: 80px 24px 24px;
        }

        .menu-user-info {
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .menu-user-email {
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            word-break: break-all;
        }

        .menu-nav {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 14px 16px;
            background: rgba(13, 168, 232, 0.1);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 600;
            text-align: left;
        }

        .menu-item:hover {
            background: rgba(13, 168, 232, 0.2);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .menu-item.logout-item {
            color: #f44336;
            background: rgba(244, 67, 54, 0.1);
            border-color: rgba(244, 67, 54, 0.3);
        }

        .menu-item.logout-item:hover {
            background: rgba(244, 67, 54, 0.2);
            border-color: #f44336;
        }
        .container { max-width: 1100px; margin: 0 auto; padding: 32px 24px 64px; }
        .profile-hero { display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 24px; }
        .hero-badge { background: rgba(58, 123, 213, 0.16); color: var(--text-secondary); padding: 6px 12px; border-radius: 999px; font-size: 12px; }
        .profile-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        .profile-section { background: rgba(255, 255, 255, 0.06); border: 1px solid var(--border-color); border-radius: 16px; padding: 20px; box-shadow: 0 12px 24px rgba(0, 0, 0, 0.12); }
        .section-title { font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
        .form-input { width: 100%; padding: 12px 14px; border-radius: 10px; border: 1px solid var(--border-color); background: rgba(255, 255, 255, 0.06); color: var(--text-primary); }
        .toggle-group { display: flex; justify-content: space-between; align-items: center; margin-top: 12px; }
        .toggle-switch { position: relative; width: 52px; height: 28px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.2); border-radius: 999px; transition: 0.2s; }
        .toggle-slider:before { position: absolute; content: ""; height: 22px; width: 22px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.2s; }
        .toggle-switch input:checked + .toggle-slider { background: var(--primary); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
        .btn { border: 1px solid var(--border-color); border-radius: 10px; padding: 12px 16px; background: rgba(255, 255, 255, 0.08); color: var(--text-primary); cursor: pointer; }
        .btn-primary { background: linear-gradient(135deg, #38e8ff, #8b5cf6); color: #0b0f14; border: none; }
        .btn-secondary { background: transparent; }
        .status-panel {
            margin-top: 12px;
            padding: 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: rgba(56, 232, 255, 0.06);
            display: grid;
            gap: 8px;
            font-size: 0.92rem;
        }
        .status-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
        }
        .status-label { color: var(--text-secondary); font-weight: 600; }
        .status-value {
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 999px;
            background: rgba(56, 232, 255, 0.16);
            color: var(--primary);
            min-width: 90px;
            text-align: center;
        }
        .status-note {
            margin-top: 8px;
            font-size: 0.82rem;
            color: var(--warning);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .guide-section {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
        }
        .guide-section h3 { margin-bottom: 8px; }
        .guide-section p { color: var(--text-secondary); font-size: 0.92rem; }
        .guide-steps { margin-top: 12px; padding-left: 18px; color: var(--text-secondary); line-height: 1.65; font-size: 0.92rem; }
        .guide-steps li { margin-bottom: 8px; }
        .guide-callout {
            margin-top: 12px;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(245, 183, 91, 0.28);
            background: rgba(245, 183, 91, 0.08);
            color: var(--warning);
            font-size: 0.9rem;
        }
        .notification { position: fixed; right: 20px; top: 20px; background: var(--surface-dark); border: 1px solid var(--border-color); padding: 12px 16px; border-radius: 10px; display: flex; align-items: center; gap: 10px; z-index: 999; animation: slideInRight 0.3s ease; }
        @keyframes slideInRight { from { transform: translateX(50px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOutRight { from { transform: translateX(0); opacity: 1; } to { transform: translateX(50px); opacity: 0; } }
        .legal-footer { text-align: center; padding: 24px; font-size: 12px; color: var(--text-secondary); }
        body.premium-locked .container { filter: blur(4px); pointer-events: none; }
        .premium-lock {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }
        .premium-lock.active { display: flex; }
        .premium-modal {
            background: var(--surface-dark);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            max-width: 420px;
            width: 100%;
            text-align: center;
            box-shadow: 0 24px 60px rgba(0, 0, 0, 0.3);
        }
        .premium-modal h2 { margin-bottom: 10px; }
        .premium-modal p { color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px; }
        .premium-actions { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
        .premium-btn {
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 600;
        }
        .premium-btn.primary { background: linear-gradient(135deg, #FFD700, #FFA500); color: #111; border: none; }
        @media (max-width: 768px) {
            .profile-hero { flex-direction: column; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-left">
            <button class="back-btn" onclick="window.goBack()"><i class="fa-solid fa-arrow-left"></i></button>
            <a href="index.html" class="logo">
                <img src="logo.svg" alt="Rolin Signal" class="logo-img" />
                <span class="logo-text">Rolin Signal</span>
            </a>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div class="user-email-header" id="userEmailHeader"></div>
            <span class="user-role-badge" id="userRoleBadge" style="display:none;"></span>
            <button class="hamburger-menu" id="hamburgerBtn" onclick="window.toggleHamburgerMenu()" title="Menü">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <div class="menu-panel" id="menuPanel">
        <button class="menu-close" onclick="closeHamburgerMenu()">×</button>
        <div class="menu-content">
            <div class="menu-user-info">
                <div class="menu-user-email" id="menuUserEmail">Yükleniyor...</div>
            </div>
            <nav class="menu-nav">
                <a href="profile.html" class="menu-item" onclick="closeHamburgerMenu()">
                    <i class="fa-solid fa-user"></i>
                    Profil
                </a>
                <a href="index.html" class="menu-item" onclick="closeHamburgerMenu()">
                    <i class="fa-solid fa-chart-line"></i>
                    Dashboard
                </a>
                <a href="her-durumda.html" class="menu-item" onclick="closeHamburgerMenu()">
                    <i class="fa-solid fa-layer-group"></i>
                    Her Durumda
                </a>
                <a href="kazananlar.html" class="menu-item" onclick="closeHamburgerMenu()">
                    <i class="fa-solid fa-trophy"></i>
                    Kazananlar
                </a>
                <a href="binance.html" class="menu-item" onclick="closeHamburgerMenu()">
                    <i class="fa-brands fa-bitcoin"></i>
                    Binance Bağlantısı
                </a>
                <button class="menu-item logout-item" onclick="window.logout()">
                    <i class="fa-solid fa-right-from-bracket"></i>
                    Çıkış Yap
                </button>
            </nav>
        </div>
    </div>

    <div class="container">
        <div class="profile-hero">
            <div>
                <h1><i class="fa-brands fa-bitcoin"></i> Binance Bağlantısı</h1>
                <p>Binance API anahtarlarınızı ve otomatik trade ayarlarınızı yönetin</p>
            </div>
            <div class="hero-badge">Premium Özellik</div>
        </div>

        <div class="profile-grid">
            <div class="profile-section">
                <div class="section-title">
                    <i class="fa-brands fa-bitcoin"></i> Binance Bağlantısı
                </div>

                <div class="info-box" style="margin-bottom: 12px; color: var(--text-secondary); font-size: 13px;">
                    API anahtarınızı Binance'den alırken sadece <strong>Enable Spot Trading</strong> ve <strong>Enable Futures</strong> izinlerini verin. <strong>Withdrawal</strong> izni vermeyin.
                </div>

                <div class="form-group">
                    <label class="form-label">API Key</label>
                    <input type="text" id="binanceApiKey" class="form-input" placeholder="API Key" autocomplete="off" />
                </div>

                <div class="form-group">
                    <label class="form-label">API Secret</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="password" id="binanceApiSecret" class="form-input" placeholder="API Secret" autocomplete="off" style="flex: 1;" />
                        <button class="btn btn-secondary" style="padding: 12px 16px; min-width: auto;" onclick="window.togglePasswordVisibility('binanceApiSecret')"><i class="fa-solid fa-eye"></i></button>
                    </div>
                </div>

                <div class="toggle-group">
                    <label class="toggle-label"><i class="fa-solid fa-robot"></i> Otomatik Trade'i Aktif Et</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="autoTradeToggle" onchange="window.updateAutoTradeUI()" />
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div style="border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; margin-top: 12px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">Futures Ayarları</div>
                    <div class="toggle-group" style="margin-top: 0;">
                        <label class="toggle-label">Futures Otomatik Trade</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="futuresEnabledToggle" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Kaldıraç</label>
                        <select id="futuresLeverage" class="form-input">
                            <option value="1">1x</option>
                            <option value="2">2x</option>
                            <option value="3">3x</option>
                            <option value="5">5x</option>
                            <option value="10" selected>10x</option>
                            <option value="20">20x</option>
                            <option value="25">25x</option>
                            <option value="50">50x</option>
                            <option value="75">75x</option>
                            <option value="100">100x</option>
                            <option value="125">125x</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Marjin Türü</label>
                        <select id="futuresMarginType" class="form-input">
                            <option value="CROSS" selected>Cross</option>
                            <option value="ISOLATED">Isolated</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pozisyon Büyüklüğü</label>
                        <select id="futuresPositionSize" class="form-input">
                            <option value="1">%1</option>
                            <option value="2">%2</option>
                            <option value="3">%3</option>
                            <option value="5" selected>%5</option>
                            <option value="10">%10</option>
                            <option value="15">%15</option>
                            <option value="20">%20</option>
                            <option value="25">%25</option>
                            <option value="30">%30</option>
                            <option value="40">%40</option>
                            <option value="50">%50</option>
                            <option value="60">%60</option>
                            <option value="70">%70</option>
                            <option value="80">%80</option>
                            <option value="90">%90</option>
                            <option value="100">%100</option>
                        </select>
                    </div>
                </div>

                <div style="border: 1px solid var(--border-color); border-radius: 12px; padding: 12px; margin-top: 12px;">
                    <div style="font-weight: 600; margin-bottom: 10px; color: var(--text-primary);">Spot Ayarları</div>
                    <div class="toggle-group" style="margin-top: 0;">
                        <label class="toggle-label">Spot Otomatik Trade</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="spotEnabledToggle" />
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pozisyon Büyüklüğü</label>
                        <select id="spotPositionSize" class="form-input">
                            <option value="1">%1</option>
                            <option value="2">%2</option>
                            <option value="3">%3</option>
                            <option value="5" selected>%5</option>
                            <option value="10">%10</option>
                            <option value="15">%15</option>
                            <option value="20">%20</option>
                            <option value="25">%25</option>
                            <option value="30">%30</option>
                            <option value="40">%40</option>
                            <option value="50">%50</option>
                            <option value="60">%60</option>
                            <option value="70">%70</option>
                            <option value="80">%80</option>
                            <option value="90">%90</option>
                            <option value="100">%100</option>
                        </select>
                    </div>
                </div>

                <div style="display: flex; gap: 12px; margin-top: 12px;">
                    <button class="btn btn-secondary" id="testBinanceBtn" onclick="window.testBinanceConnection()"><i class="fa-solid fa-plug"></i> API Bağlantısını Test Et</button>
                    <button class="btn btn-primary" id="saveBinanceBtn" onclick="window.saveBinanceSettings()"><i class="fa-solid fa-floppy-disk"></i> Kaydet</button>
                </div>

                <div class="status-panel">
                    <div class="status-row">
                        <span class="status-label">Bağlantı durumu</span>
                        <strong id="binanceConnectionStatus" class="status-value">Bilinmiyor</strong>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Futures Bakiye</span>
                        <strong id="binanceFuturesBalance" class="status-value">-</strong>
                    </div>
                    <div class="status-row">
                        <span class="status-label">Spot Bakiye</span>
                        <strong id="binanceSpotBalance" class="status-value">-</strong>
                    </div>
                    <div class="status-note">
                        <i class="fa-solid fa-circle-exclamation"></i>
                        Otomatik trade kapalıyken test başlatılamaz. Önce Otomatik Trade'i açın.
                    </div>
                </div>

                <div style="background: rgba(245, 183, 91, 0.08); border: 1px solid rgba(245, 183, 91, 0.2); border-radius: 8px; padding: 12px; margin-top: 12px;">
                    <p style="color: var(--warning); font-size: 12px;">
                        <i class="fa-solid fa-triangle-exclamation"></i> Otomatik trade işlemleri tamamen sizin sorumluluğunuzdadır. Kayıp riski vardır.
                    </p>
                    <p style="color: var(--text-secondary); font-size: 12px; margin-top: 6px;">
                        <i class="fa-solid fa-circle-info"></i> Bar kapanışı hesaplaması Binance otomatik trade'de desteklenmiyor.
                    </p>
                    <ul style="color: var(--text-secondary); font-size: 12px; margin-top: 8px; padding-left: 18px; line-height: 1.6;">
                        <li>Futures için <strong>One‑Way</strong> pozisyon modu kullanın (Hedge kapalı olmalı).</li>
                        <li>Spot TP/SL OCO kullanır; fiyat koşulları uygunsa Binance kabul eder.</li>
                        <li>Minimum miktar/precision nedeniyle küçük bakiyelerde işlem açılmayabilir.</li>
                    </ul>
                </div>

                <div class="guide-section">
                    <h3 class="section-title"><i class="fa-solid fa-key"></i> Binance API Key nasıl alınır?</h3>
                    <p>API anahtarınızı oluşturup gerekli izinleri doğru seçmeniz gerekir. Aşağıdaki adımları sırayla uygulayın.</p>
                    <ol class="guide-steps">
                        <li>Binance hesabınıza giriş yapın ve sağ üstten <strong>Profil → API Management</strong> bölümüne girin.</li>
                        <li><strong>Create API</strong> (veya <strong>API Oluştur</strong>) butonuna tıklayın, bir etiket adı yazın.</li>
                        <li>Güvenlik doğrulamalarını tamamlayın (SMS/E‑posta/2FA).</li>
                        <li><strong>API Key Permissions</strong> bölümünde:
                            <ul>
                                <li><strong>Enable Spot & Margin Trading</strong> açın.</li>
                                <li><strong>Enable Futures</strong> açın.</li>
                                <li><strong>Withdraw</strong> iznini kesinlikle <strong>kapalı</strong> bırakın.</li>
                            </ul>
                        </li>
                        <li><strong>IP Access Restrictions</strong> kısmında <strong>Unrestricted (Less Secure)</strong> seçin.</li>
                        <li>Değişiklikleri kaydedin ve size gösterilen <strong>API Key</strong> ile <strong>Secret Key</strong> değerlerini kopyalayın. (Secret yalnızca bir kez gösterilir.)</li>
                        <li>Bu sayfadaki alanlara yapıştırıp <strong>Kaydet</strong> butonuna basın, ardından <strong>API Bağlantısını Test Et</strong> butonuyla doğrulayın.</li>
                    </ol>
                    <div class="guide-callout">
                        <strong>Not:</strong> Platform isteği sabit IP kullanmadığı için <strong>IP Restriction</strong> seçerseniz bağlantı testinde hata alabilirsiniz. Güvenlik için 2FA aktif olsun ve <strong>Withdraw</strong> iznini kapalı tutun.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="premium-lock" id="premiumLock" aria-hidden="true">
        <div class="premium-modal">
            <h2>Premium gerekli</h2>
            <p>Binance bağlantısı sadece Premium üyeler için aktif.</p>
            <div class="premium-actions">
                <a href="premium.html" class="premium-btn primary"><i class="fa-solid fa-star"></i> Premium Ol</a>
                <a href="index.html" class="premium-btn"><i class="fa-solid fa-chart-line"></i> Dashboard'a Dön</a>
            </div>
        </div>
    </div>

    <div class="legal-footer">
        Yatırım danışmanlığı değildir; genel bilgilendirme amaçlıdır, sorumluluk kullanıcıya aittir.
    </div>

    <script>
        let supabaseClient = null;
        let currentUser = null;
        let notificationCount = 0;
        const ADMIN_EMAIL = 'asd@asd.com';
        let isLoadingBinanceSettings = false;
        let autoSaveTimer = null;

        function updateNotificationPositions() {
            const notifications = Array.from(document.querySelectorAll('.notification'));
            notifications.forEach((notification, index) => {
                notification.dataset.index = index;
                const topPosition = 20 + (index * 110);
                notification.style.top = topPosition + 'px';
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            const iconClass = {
                success: 'fa-circle-check',
                error: 'fa-circle-xmark',
                warning: 'fa-triangle-exclamation',
                info: 'fa-circle-info'
            }[type] || 'fa-circle-info';
            notification.innerHTML = `<span class="notification-icon"><i class="fa-solid ${iconClass}"></i></span><span class="notification-text"></span>`;
            notification.querySelector('.notification-text').textContent = message;
            notification.dataset.index = notificationCount;
            notificationCount++;

            document.body.appendChild(notification);
            const topPosition = 20 + (notification.dataset.index * 110);
            notification.style.top = topPosition + 'px';

            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                    updateNotificationPositions();
                }, 300);
            }, 4000);
        }

        window.toggleHamburgerMenu = function() {
            document.getElementById('menuPanel').classList.toggle('active');
            document.getElementById('hamburgerBtn').classList.toggle('active');
        };
        window.closeHamburgerMenu = function() {
            document.getElementById('menuPanel').classList.remove('active');
            document.getElementById('hamburgerBtn').classList.remove('active');
        };
        window.goBack = function() { window.history.back(); };

        window.logout = async function() {
            try {
                if (supabaseClient) {
                    await supabaseClient.auth.signOut();
                }
            } catch {}
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'index.html';
        };

        window.togglePasswordVisibility = function(fieldId) {
            const field = document.getElementById(fieldId);
            if (field.type === 'password') field.type = 'text';
            else field.type = 'password';
        };

        function updateUserRoleBadge(membershipType, isAdmin) {
            const badgeEl = document.getElementById('userRoleBadge');
            if (!badgeEl) return;

            if (isAdmin) {
                badgeEl.innerHTML = '<i class="fa-solid fa-shield"></i> Admin';
                badgeEl.className = 'user-role-badge admin';
                badgeEl.style.display = 'inline-flex';
                return;
            }

            if (membershipType === 'premium') {
                badgeEl.innerHTML = '<i class="fa-solid fa-star"></i> Premium';
                badgeEl.className = 'user-role-badge premium';
                badgeEl.style.display = 'inline-flex';
                return;
            }

            badgeEl.innerHTML = '<i class="fa-solid fa-leaf"></i> Free';
            badgeEl.className = 'user-role-badge standard';
            badgeEl.style.display = 'inline-flex';
        }

        window.updateAutoTradeUI = function() {
            const autoToggle = document.getElementById('autoTradeToggle');
            const enabled = autoToggle ? autoToggle.checked : false;
            const ids = [
                'futuresEnabledToggle',
                'spotEnabledToggle',
                'futuresLeverage',
                'futuresMarginType',
                'futuresPositionSize',
                'spotPositionSize',
                'testBinanceBtn'
            ];
            ids.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.disabled = !enabled;
            });
        };

        function queueAutoSave() {
            if (isLoadingBinanceSettings || !currentUser) return;
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(() => {
                window.saveBinanceSettings();
            }, 800);
        }

        async function loadBinanceSettings() {
            if (!currentUser) return;
            isLoadingBinanceSettings = true;
            try {
                const { data } = await supabaseClient
                    .from('user_binance_keys')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .maybeSingle();

                if (!data) return;

                document.getElementById('binanceApiKey').value = data.api_key || '';
                document.getElementById('binanceApiSecret').value = data.api_secret || '';
                document.getElementById('autoTradeToggle').checked = !!data.auto_trade_enabled;
                document.getElementById('futuresEnabledToggle').checked = !!data.futures_enabled;
                document.getElementById('spotEnabledToggle').checked = !!data.spot_enabled;
                document.getElementById('futuresLeverage').value = String(data.futures_leverage || 10);
                document.getElementById('futuresMarginType').value = String(data.futures_margin_type || 'CROSS');
                document.getElementById('futuresPositionSize').value = String(data.futures_position_size_percent || 5);
                document.getElementById('spotPositionSize').value = String(data.spot_position_size_percent || 5);
            } catch (e) {
                console.error('Binance ayarları yükleme hatası:', e);
            } finally {
                isLoadingBinanceSettings = false;
            }
        }

        function setupAutoSaveListeners() {
            const ids = [
                'binanceApiKey',
                'binanceApiSecret',
                'autoTradeToggle',
                'futuresEnabledToggle',
                'spotEnabledToggle',
                'futuresLeverage',
                'futuresMarginType',
                'futuresPositionSize',
                'spotPositionSize'
            ];

            ids.forEach(id => {
                const el = document.getElementById(id);
                if (!el) return;
                el.addEventListener('input', queueAutoSave);
                el.addEventListener('change', queueAutoSave);
            });
        }

        window.saveBinanceSettings = async function() {
            if (!currentUser) {
                showNotification('Lütfen giriş yapınız!', 'error');
                return;
            }

            const apiKey = document.getElementById('binanceApiKey').value.trim();
            const apiSecret = document.getElementById('binanceApiSecret').value.trim();
            const autoTradeEnabled = document.getElementById('autoTradeToggle').checked;
            const futuresEnabled = document.getElementById('futuresEnabledToggle').checked;
            const spotEnabled = document.getElementById('spotEnabledToggle').checked;
            const futuresLeverage = Number(document.getElementById('futuresLeverage').value || 10);
            const futuresMarginType = String(document.getElementById('futuresMarginType').value || 'CROSS');
            const futuresPositionSize = Number(document.getElementById('futuresPositionSize').value || 5);
            const spotPositionSize = Number(document.getElementById('spotPositionSize').value || 5);

            if (autoTradeEnabled) {
                if (!apiKey || apiKey.length < 20) {
                    showNotification('API Key geçersiz.', 'error');
                    return;
                }
                if (!apiSecret || apiSecret.length < 20) {
                    showNotification('API Secret geçersiz.', 'error');
                    return;
                }
            }

            try {
                const payload = {
                    user_id: currentUser.id,
                    api_key: apiKey || '',
                    api_secret: apiSecret || '',
                    auto_trade_enabled: !!autoTradeEnabled,
                    futures_enabled: !!futuresEnabled,
                    futures_leverage: futuresLeverage,
                    futures_margin_type: futuresMarginType,
                    futures_position_size_percent: futuresPositionSize,
                    spot_enabled: !!spotEnabled,
                    spot_position_size_percent: spotPositionSize,
                    updated_at: new Date().toISOString()
                };

                const { error } = await supabaseClient
                    .from('user_binance_keys')
                    .upsert(payload, { onConflict: 'user_id' });

                if (error) throw error;
                showNotification('Binance ayarları kaydedildi.', 'success');
            } catch (e) {
                console.error('Binance ayarları kaydetme hatası:', e);
                showNotification('Binance ayarları kaydedilemedi: ' + (e?.message || 'Hata'), 'error');
            }
        };

        window.testBinanceConnection = async function() {
            const apiKey = document.getElementById('binanceApiKey').value.trim();
            const apiSecret = document.getElementById('binanceApiSecret').value.trim();

            if (!apiKey || !apiSecret) {
                showNotification('API Key ve Secret gerekli.', 'error');
                return;
            }

            const statusEl = document.getElementById('binanceConnectionStatus');
            const futuresEl = document.getElementById('binanceFuturesBalance');
            const spotEl = document.getElementById('binanceSpotBalance');

            if (statusEl) statusEl.textContent = 'Test ediliyor...';
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (SUPABASE_ANON_KEY) {
                    headers['apikey'] = SUPABASE_ANON_KEY;
                    headers['Authorization'] = 'Bearer ' + SUPABASE_ANON_KEY;
                }

                const response = await fetch(TELEGRAM_FUNCTION_URL, {
                    method: 'POST',
                    headers,
                    body: JSON.stringify({
                        action: 'test_binance_connection',
                        api_key: apiKey,
                        api_secret: apiSecret
                    })
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    if (statusEl) statusEl.textContent = 'Bağlı';
                    if (futuresEl) futuresEl.textContent = `$${Number(result.futures_balance || 0).toFixed(2)}`;
                    if (spotEl) spotEl.textContent = `$${Number(result.spot_balance || 0).toFixed(2)}`;
                    showNotification('Binance bağlantısı başarılı.', 'success');
                } else {
                    if (statusEl) statusEl.textContent = 'Bağlı Değil';
                    showNotification(result.error || 'Bağlantı başarısız.', 'warning');
                }
            } catch (e) {
                if (statusEl) statusEl.textContent = 'Bağlı Değil';
                showNotification('Bağlantı başarısız.', 'error');
            }
        };

        async function loadAccess() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.replace('login.html');
                return;
            }

            currentUser = session.user;
            document.getElementById('userEmailHeader').textContent = currentUser.email;
            document.getElementById('menuUserEmail').textContent = currentUser.email;

            const isAdminByEmail = String(currentUser.email || '').toLowerCase() === ADMIN_EMAIL;
            const { data: userProfile } = await supabaseClient
                .from('user_profiles')
                .select('membership_type, is_admin')
                .eq('id', currentUser.id)
                .maybeSingle();

            const isAdmin = isAdminByEmail || !!userProfile?.is_admin;
            const isPremium = (userProfile?.membership_type || 'standard') === 'premium' || isAdmin;

            updateUserRoleBadge(userProfile?.membership_type || 'standard', isAdmin);

            if (!isPremium) {
                showPremiumLock();
                return;
            }

            await loadBinanceSettings();
            window.updateAutoTradeUI();
            setupAutoSaveListeners();
        }

        document.addEventListener('DOMContentLoaded', async () => {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            await loadAccess();
        });

        function showPremiumLock() {
            const lockEl = document.getElementById('premiumLock');
            if (lockEl) {
                lockEl.classList.add('active');
                lockEl.setAttribute('aria-hidden', 'false');
            }
            document.body.classList.add('premium-locked');
        }
    </script>
</body>
</html>
